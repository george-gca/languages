name: Run benchmarks

on:
  push:
    branches:
      - main
    paths:
      - "**/**"
      - "**.sh"
      - "!.github/**"
      - "!README.md"
  pull_request:
    branches:
      - main
    paths:
      - "**/**"
      - "**.sh"
      - "!.github/**"
      - "!README.md"
  workflow_dispatch:
    inputs:
      runs:
        default: 5 # https://docs.github.com/en/actions/administering-github-actions/usage-limits-billing-and-administration#usage-limits
        description: "Number of benchmarking runs"
        required: false

permissions:
  contents: write

jobs:
  run-benchmarks:
    # available images: https://github.com/actions/runner-images#available-images
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest
      - name: Setup C
        uses: aminya/setup-cpp@v1
        with:
          compiler: gcc
      - name: Setup Dart
        uses: dart-lang/setup-dart@v1
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23.3'
      - name: Setup Deno
        uses: denoland/setup-deno@v2
        with:
          deno-version: vx.x.x
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu' # https://github.com/actions/setup-java?tab=readme-ov-file#supported-distributions
          java-version: '21' # https://github.com/actions/setup-java?tab=readme-ov-file#supported-version-syntax
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.4'
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - uses: r-lib/actions/setup-r@v2
        with:
          r-version: '3.5.3'
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.3'
      - name: Setup Rust
        uses: moonrepo/setup-rust@v1
        with:
          channel: '1.65.0'
      - name: Install hyperfine and run benchmarks ðŸ”§
        run: |
          HYPERFINE_VERSION="1.19.0"
          wget https://github.com/sharkdp/hyperfine/releases/download/v"$HYPERFINE_VERSION"/hyperfine_"$HYPERFINE_VERSION"_amd64.deb
          sudo dpkg -i hyperfine_"$HYPERFINE_VERSION"_amd64.deb
          rm hyperfine_"$HYPERFINE_VERSION"_amd64.deb
          for dir in ./*/; do
            cd $dir
            bash ../run.sh ${{ github.event.inputs.runs || 1 }}
            cd ..
          done
      # commit all changed files back to the repository
      - uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Changed output tables
